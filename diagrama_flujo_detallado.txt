# ğŸ“Š DIAGRAMA DE FLUJO DETALLADO

## 1. FLUJO PRINCIPAL (main.py)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [1. INICIO]                                                          â”‚
â”‚ - Recibe parÃ¡metros de entrada                                       â”‚
â”‚ - Valida el archivo de video                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [2. CONFIGURACIÃ“N INICIAL]                                           â”‚
â”‚ - Abre el video con cv2.VideoCapture()                               â”‚
â”‚ - Prepara el video de salida con cv2.VideoWriter()                   â”‚
â”‚ - Establece parÃ¡metros por defecto si no se especifican:             â”‚
â”‚   â€¢ k=256, gamma=3, alow=0.95, ahigh=0.95, amin=0, amax=255         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [3. BUCLE PRINCIPAL]                                                 â”‚
â”‚ while cap.isOpened():                                                â”‚
â”‚   1. Lee frame del video                                             â”‚
â”‚   2. Si no hay mÃ¡s frames, termina                                   â”‚
â”‚   3. Procesa el frame (llama a process_frame)                        â”‚
â”‚   4. Muestra el frame original y el procesado                        â”‚
â”‚   5. Guarda el frame procesado en el video de salida                 â”‚
â”‚   6. Espera entrada de teclado para controles interactivos           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [4. FUNCIÃ“N process_frame]                                            â”‚
â”‚ ParÃ¡metros: frame, k=256, gamma=3, alow=0.95, ahigh=0.95, amin=0, amax=255
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â–¼                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [4.1] Redimensionar â”‚           â”‚ [4.2] Separar canalesâ”‚
â”‚ - cv2.resize()      â”‚           â”‚ - cv2.split()        â”‚
â”‚ - Escala: 70%       â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
           â”‚                                 â–¼
           â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                     â”‚ [4.3] gamma_correction â”‚
           â”‚                     â”‚ - Ajusta brillo        â”‚
           â”‚                     â”‚ - Mejora contraste     â”‚
           â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                               â”‚
           â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [4.4] equalize_histogram_hsv                         â”‚
â”‚ - Convierte a HSV                                   â”‚
â”‚ - Ecualiza el canal V                               â”‚
â”‚ - k=256: nÃºmero de niveles de intensidad            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [4.5] ajustar_contraste_hsv                          â”‚
â”‚ - alow=0.95: recorta 5% valores bajos                â”‚
â”‚ - ahigh=0.95: recorta 5% valores altos               â”‚
â”‚ - Estira el histograma entre amin=0 y amax=255       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [4.6] Aplicar mÃ¡scara                                â”‚
â”‚ - Crea regiÃ³n de interÃ©s rectangular                 â”‚
â”‚ - Enfoca Ã¡rea donde se esperan las lÃ­neas            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [5. RESULTADO]                                       â”‚
â”‚ - Frame procesado listo para mostrar/guardar         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2. DETALLE DE FUNCIONES DE UTILS.PY

### 2.1 gamma_correction(b, g, r, gamma)
- **Entrada**: Canales B, G, R del frame
- **Proceso**: 
  ```python
  b_corrected = 255 * (b/255) ** gamma
  g_corrected = 255 * (g/255) ** gamma
  r_corrected = 255 * (r/255) ** gamma
  ```
- **PropÃ³sito**: Ajusta la intensidad para mejorar la visibilidad
- **gamma=3**: Ã‰nfasis en Ã¡reas oscuras

### 2.2 equalize_histogram_hsv(frame, k)
- **Entrada**: Frame en BGR, k=256 niveles
- **Proceso**:
  1. Convierte a HSV
  2. Ecualiza el canal V
  3. Aplica mapeo de intensidades
- **k=256**: Porque es el estÃ¡ndar para imÃ¡genes de 8 bits

### 2.3 ajustar_contraste_hsv(frame, alow, ahigh, amin, amax)
- **Entrada**: Frame en BGR, parÃ¡metros de contraste
- **Proceso**:
  1. Calcula histograma acumulativo
  2. Encuentra los percentiles alow y ahigh
  3. Estira el histograma entre amin y amax
- **alow=0.95**: Recorta el 5% de valores bajos
- **ahigh=0.95**: Recorta el 5% de valores altos

### 2.4 mascara(frame)
- **Entrada**: Frame en escala de grises
- **Proceso**:
  ```python
  mask = np.zeros_like(frame)
  cv2.rectangle(mask, (x1,y1), (x2,y2), 255, -1)
  return cv2.bitwise_and(frame, frame, mask=mask)
  ```
- **PropÃ³sito**: Enfocar solo el Ã¡rea de interÃ©s

## 3. FLUJO DE DATOS ENTRE FUNCIONES

```
Frame Original
      â”‚
      â–¼
[Redimensionar a 70%]  â”€â”€â”€â”
      â”‚                    â”‚
      â–¼                    â”‚
[Separar canales B,G,R]    â”‚
      â”‚                    â”‚
      â–¼                    â”‚
[gamma_correction]         â”‚
      â”‚                    â”‚
      â–¼                    â”‚
[equalize_histogram_hsv]   â”‚
      â”‚                    â”‚
      â–¼                    â”‚
[ajustar_contraste_hsv]    â”‚
      â”‚                    â”‚
      â–¼                    â”‚
[Convertir a escala de grises]
      â”‚                    â”‚
      â–¼                    â”‚
   [mascara]               â”‚
      â”‚                    â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
        Frame Procesado
```

## 4. PROPÃ“SITO DE CADA ETAPA

1. **Redimensionamiento**: 
   - Reduce tiempo de procesamiento
   - Mantiene suficiente detalle

2. **CorrecciÃ³n Gamma**:
   - Mejora visibilidad en sombras
   - Ajusta el balance de brillo

3. **EcualizaciÃ³n HSV**:
   - Normaliza la iluminaciÃ³n
   - Mejora el contraste global

4. **Ajuste de Contraste**:
   - Mejora el rango dinÃ¡mico
   - Reduce el efecto de iluminaciÃ³n desigual

5. **MÃ¡scara**:
   - Enfoca el Ã¡rea de interÃ©s
   - Reduce falsos positivos
   - Mejora el rendimiento

## 5. EJEMPLO DE USO

```python
# Procesar un frame con parÃ¡metros personalizados
frame_procesado = process_frame(
    frame,               # Frame de entrada
    k=300,              # MÃ¡s niveles de intensidad
    gamma=2.5,          # Menos oscuro que el default
    alow=0.90,          # MÃ¡s sensible a sombras
    ahigh=0.97,         # Menos recorte en luces
    amin=10,            # Evita negros puros
    amax=240            # Evita blancos quemados
)
```

## 6. NOTAS ADICIONALES

- El orden del pipeline es crÃ­tico para los resultados
- Los valores por defecto estÃ¡n optimizados para condiciones normales de iluminaciÃ³n
- Ajustar parÃ¡metros segÃºn las condiciones especÃ­ficas del video
- La mÃ¡scara debe ajustarse segÃºn la perspectiva de la cÃ¡mara
